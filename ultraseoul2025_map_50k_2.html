<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1080">
  <title>ULTRA SEOUL 2025 - 50K GPX</title>
  <!-- Pretendard CDN (font-face 방식: CSP 에러 없음) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.8/dist/web/static/pretendard.css">
  <!-- Leaflet CSS CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body { margin:0; padding:0; background:#191c1d; font-family:Pretendard, 'Segoe UI', Arial, sans-serif; }
    #container { max-width: 1080px; margin: 0 auto; }
    #map { width: 100%; max-width: 648px; height: 158px; border-radius: 1.1em 1.1em 0 0; box-shadow: 0 2px 17px rgba(0,0,0,0.20); background: #181c22; margin:0 auto; }
    #elevationBox { width: 100%; max-width: 648px; height: 79px; background: #fff; border-radius: 0 0 1.1em 1.1em; box-shadow: 0 2px 10px rgba(0,0,0,0.07); margin: 0 auto 2.8vw auto; position: relative; }
    #elevInfoTable { position: absolute; left: 50%; top: 0.9em; transform: translateX(-50%); z-index: 10; font-family: Pretendard, 'Segoe UI', Arial, sans-serif; }
    #elevation { width: 100%; max-width: 606px; height: 75px; margin: 0 auto; display: block; background: #fff; border-radius: 0.6em;}
    #downloadBox { width: 100%; max-width: 410px; min-width: 160px; background: #e70013; border-radius: 2.2em; color: #fff; font-family: Pretendard, sans-serif; padding: 0.6em 1.5em; box-shadow: 0 6px 24px rgba(231,0,19,0.16); font-size: 1.11em; margin: 2.5em auto 2em auto; text-align: center;}
    .ultraseoul-btn { background: #e70013; color: #fff; font-family: Pretendard, 'Segoe UI', Arial, sans-serif; font-size: 1.1em; font-weight: 700; border: none; border-radius: 2.2em; box-shadow: 0 6px 19px rgba(231,0,19,0.14); padding: 0.5em 1.4em; min-width: 7em; text-align: center; text-decoration: none; }
    .ultraseoul-btn:hover { background: #c90012; }
    #gpxErrorMsg { color: #e70013; font-size: 1.1em; margin: 2em auto; text-align: center; font-family: Pretendard;}
  </style>
</head>
<body>
  <div id="container">
    <div id="map"></div>
    <div id="elevationBox">
      <div id="elevInfoTable"></div>
      <canvas id="elevation"></canvas>
      <div id="gpxErrorMsg" style="display:none;"></div>
    </div>
    <div id="downloadBox">
      <a href="./ultraseoul2025_50k_gm.gpx" download="ultraseoul2025_50k_gm.gpx" class="ultraseoul-btn">GPX DOWNLOAD</a>
    </div>
  </div>
  <!-- Leaflet JS CDN -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.js"></script>
  <script>
  // GPX 파일 경로는 반드시 html과 같은 폴더에 둘 것!
  const gpxUrl = './ultraseoul2025_50k_gm.gpx';

  let map, chart, elevations=[], distances=[], latlngs=[];
  let totalAsc=0, totalDesc=0;

  function showGpxError(msg) {
    const errBox = document.getElementById('gpxErrorMsg');
    errBox.style.display = 'block';
    errBox.innerText = msg || "코스 GPX 파일을 불러올 수 없습니다. 파일 위치와 파일명을 확인해 주세요.";
  }

  function getDistance(lat1,lon1,lat2,lon2){
    const R=6371000,toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }

  function drawElevInfoTable() {
    if (!elevations.length || !distances.length) return;
    const maxEle = Math.max(...elevations);
    const totalUp = Math.round(totalAsc);
    const totalDown = Math.round(totalDesc);
    const totalDist = (distances[distances.length-1]/1000).toFixed(2);
    document.getElementById('elevInfoTable').innerHTML = `
      <span><b>거리:</b> ${totalDist}km</span> <span><b>누적상승:</b> ${totalUp}m</span> <span><b>누적하강:</b> ${totalDown}m</span> <span><b>최고고도:</b> ${maxEle}m</span>
    `;
  }

  function drawElevationChart() {
    if (!elevations.length || !distances.length) return;
    const kmArr=distances.map(m=>(m/1000).toFixed(2));
    const ctx=document.getElementById('elevation').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels:kmArr,
        datasets:[{
          label:'고도(m)',data:elevations,
          borderColor:'#16649A',
          backgroundColor:'rgba(22,100,154,0.10)',
          borderWidth:2, pointRadius:0, fill:true, tension:0.15
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{enabled:true}},
        scales:{
          x:{display:true,title:{display:true,text:'Distance(km)'}},
          y:{display:true,title:{display:true,text:'Height(m)'}}
        }
      }
    });
  }

  window.onload = function() {
    // 지도 생성
    map = L.map('map', {
      dragging:true, scrollWheelZoom:false, doubleClickZoom:false,
      boxZoom:false, touchZoom:false, keyboard:false,
      zoomControl:false, attributionControl:false,
    }).setView([37.125,128.97],12);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom:17, attribution:'Tiles © Esri'
    }).addTo(map);

    // GPX 로드
    fetch(gpxUrl)
      .then(res=>{
        if (!res.ok) throw new Error();
        return res.text();
      })
      .then(xmlText=>{
        try {
          document.getElementById('gpxErrorMsg').style.display = 'none';
          const parser=new DOMParser();
          const xml=parser.parseFromString(xmlText,"application/xml");
          const trkpts=xml.querySelectorAll('trkpt');
          if (trkpts.length === 0) throw new Error();
          latlngs=[]; elevations=[]; distances=[0];
          trkpts.forEach((pt,i)=>{
            const lat=+pt.getAttribute('lat'), lon=+pt.getAttribute('lon');
            const ele=+pt.querySelector('ele').textContent;
            latlngs.push([lat,lon]); elevations.push(ele);
            if(i>0) distances[i]=distances[i-1]+getDistance(latlngs[i-1][0],latlngs[i-1][1],lat,lon);
          });
          totalAsc=0; totalDesc=0;
          for(let i=1;i<elevations.length;i++){
            const diff=elevations[i]-elevations[i-1];
            if(diff>0) totalAsc+=diff; else totalDesc-=diff;
          }
          const polyline=L.polyline(latlngs,{
            color:'#16649A',weight:4,opacity:0.99,lineCap:'round'
          }).addTo(map);
          map.fitBounds(polyline.getBounds(),{padding:[17,17]});
          drawElevInfoTable();
          drawElevationChart();
        } catch(e) {
          showGpxError();
        }
      })
      .catch(()=>showGpxError());
  };
  </script>
</body>
</html>
