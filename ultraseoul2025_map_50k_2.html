<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1300">
  <title>ULTRA SEOUL 2025 - 50K GPX</title>
  <!-- Pretendard: 반드시 CDN으로만! -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.8/dist/web/static/pretendard.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root {
      --color-point: #e70013;
      --color-elev-line: #16649A;
      --color-x-label: #e70013;
      --color-x-label-cp: #e70013;
      --btn-radius: 2.2em;
      --btn-font: Pretendard, 'Segoe UI', Arial, sans-serif;
    }
    html, body { margin:0; padding:0; background:#191c1d; font-family:Pretendard, 'Segoe UI', Arial, sans-serif; }
    #container { max-width: 1300px; margin: 0 auto; }
    #map-wrap { position:relative; }
    #map {
      width: 100vw; max-width: 1300px; height: 42vw; min-height: 350px; max-height: 570px;
      border-radius: 1.1em 1.1em 0 0;
      box-shadow: 0 2px 17px rgba(0,0,0,0.20);
      overflow: hidden;
      background: #191c1d;
      z-index: 1;
    }
    #downloadBox {
      position: absolute;
      left: 50%; bottom: 1.5em; transform: translateX(-50%);
      background: var(--color-point);
      border-radius: 2.2em;
      color: #fff;
      font-family: Pretendard, sans-serif;
      min-width: 20em;
      min-height: 3.3em;
      padding: 0.8em 2.9em;
      box-shadow: 0 6px 24px rgba(231,0,19,0.16);
      font-size: 1.4em;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 10;
      font-weight: 500;
      letter-spacing: 0.01em;
    }
    #downloadBox .ultraseoul-btn {
      margin-top: 0.5em;
    }
    .ultraseoul-btn {
      background: var(--color-point);
      color: #fff;
      font-family: Pretendard, 'Segoe UI', Arial, sans-serif;
      font-size: 1.1em;
      font-weight: 700;
      border: none;
      border-radius: var(--btn-radius);
      box-shadow: 0 6px 19px rgba(231,0,19,0.14);
      padding: 0.74em 2.3em;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: background .18s, box-shadow .18s, color .15s;
      display: inline-block;
      user-select: none;
      min-width: 9em;
      text-align: center;
      text-decoration: none;
    }
    .ultraseoul-btn:hover,
    .ultraseoul-btn:focus {
      background: #c90012;
      box-shadow: 0 4px 13px rgba(231,0,19,0.17);
      color: #fff;
      text-decoration: none;
    }
    .ultraseoul-btn:active {
      background: #b6000f;
      color: #fff;
      box-shadow: 0 1.5px 5px rgba(231,0,19,0.10);
    }
    #elevationBox {
      width: 100vw; max-width: 1300px; min-width: 320px;
      height: 19vw; min-height: 215px; max-height: 300px;
      background: #fff;
      border-radius: 0 0 1.1em 1.1em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      margin-bottom: 3vw;
      position: relative;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 4.5em;
    }
    #elevInfoTable {
      position: absolute;
      left: 50%; top: 0.9em; transform: translateX(-50%);
      z-index: 10; display: flex; gap: 1.7em;
      background: rgba(255,255,255,0.98);
      border-radius: 0.8em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1.5px solid #eee;
      padding: 0.8em 2.4em;
      font-size: 1.17em;
      font-weight: 500;
      color: #262626;
      min-width: 19em;
      justify-content: center;
      align-items: center;
      font-family: Pretendard, 'Segoe UI', Arial, sans-serif;
      letter-spacing: 0.01em;
    }
    #elevInfoTable .label { color: #666; font-weight: 400; margin-right: 0.3em; }
    #elevInfoTable .value { color: var(--color-point); font-weight: 700; }
    #elevation {
      width: 97vw; max-width: 1220px; min-width: 260px;
      height: 11vw; min-height: 110px; max-height: 170px;
      margin: 0 auto; display: block; background: #fff;
      border-radius: 0.6em;
    }
    #cpMarks {
      width: 97vw; max-width: 1220px; min-width: 260px;
      position: absolute; left: 1.8vw; top: 4.1em; height: 170px; z-index: 11; pointer-events: none;
    }
    .cp-vertline {
      position: absolute; width: 0.16em; height: 8.6vw; min-height: 44px; max-height: 150px; top: 2vw;
      background: rgba(231,0,19,0.22); left:0; border-radius: 2px;
    }
    .cp-dot {
      position: absolute; width: 1.2em; height: 1.2em; left: -0.5em; top: 9.8vw; min-top: 68px; max-top: 160px;
      background: var(--color-point); border-radius: 50%; border: 0.22em solid #fff; z-index: 2;
      box-shadow: 0 2px 7px rgba(231,0,19,0.11);
    }
    .cp-label {
      position: absolute; left: 50%; top: 0; transform: translateX(-50%);
      font-size: 1em; color: var(--color-point); font-weight: 700;
      text-align: center; font-family: Pretendard,'Segoe UI',Arial,sans-serif;
      background: none; border-radius: 0.3em; padding: 0 0.4em; user-select: none; pointer-events: none;
      letter-spacing: 0.01em;
      margin-bottom: 0.1em;
    }
    .hoverInfo {
      position: absolute; pointer-events: none; z-index: 1000;
      background: #fff; border: 2px solid var(--color-point);
      border-radius: 0.7em; color: #1a1a1a; font-size: 1.1em;
      font-family: Pretendard, sans-serif;
      padding: 0.48em 1.3em; box-shadow: 0 2px 10px rgba(231,0,19,0.14);
      font-weight: 600; white-space: nowrap; transition:top .07s,left .07s;
      display: none;
    }
    .km-label {
      color: #fff; font-weight: bold; font-size: 1.09em; text-align: center;
      text-shadow: none; pointer-events: none; font-family: Pretendard, sans-serif;
      background: none; border-radius: 0;
    }
    .start-label, .end-label {
      background: var(--color-point); color: #fff; font-weight: 700; font-size: 1em;
      padding: 0.18em 1.2em; border-radius: 1.1em; border: 2px solid #fff;
      font-family: Pretendard, sans-serif; box-shadow: none; pointer-events: none; user-select: none;
      display: inline-block; letter-spacing: 0.02em; text-align: center;
      line-height: 1.15em; min-width: 4.7em;
    }
    @media (max-width: 900px) {
      #container, #map, #elevationBox { max-width: 99vw; }
      #elevInfoTable { font-size: 1em; min-width: 11em; }
      #downloadBox { min-width: 13em; font-size: 1em; }
      .ultraseoul-btn { font-size: 1em; padding: 0.65em 1.3em; min-width: 7em; }
    }
    @media (max-width: 650px) {
      #container, #map, #elevationBox { max-width: 100vw; min-width: 100vw; }
      #elevInfoTable { padding: 0.4em 0.5em; font-size:0.95em;}
      #downloadBox { padding: 0.7em 1.2em; font-size: 0.92em;}
      .cp-label { font-size: 0.87em; }
      #elevation { min-width: 120px; }
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="map-wrap" style="position:relative;">
      <div id="map"></div>
      <div id="downloadBox">
        ULTRA SEOUL 2025 - 50K GPX (medium)<br>
        <a href="./ultraseoul2025_50k_gm.gpx" download="ultraseoul2025_50k_gm.gpx" class="ultraseoul-btn">DOWNLOAD</a>
      </div>
      <div id="hoverInfoMap" class="hoverInfo"></div>
    </div>
    <div id="elevationBox">
      <div id="elevInfoTable"></div>
      <div id="cpMarks"></div>
      <canvas id="elevation"></canvas>
      <div id="hoverInfoElev" class="hoverInfo"></div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.js"></script>
  <script>
  const gpxUrl = './ultraseoul2025_50k_gm.gpx';

  // 지도: 위성+지형 강조(Esri WorldImagery), 옵션최소화
  const map = L.map('map', {
    dragging:true, scrollWheelZoom:false, doubleClickZoom:false,
    boxZoom:false, touchZoom:false, keyboard:false,
    zoomControl:false, attributionControl:false,
  }).setView([37.6413,127.1116],13);

  // 위성 이미지 타일 (Esri WorldImagery, 무료)
  const imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom:17, attribution:'Tiles © Esri'
  }).addTo(map);

  // 지도 색감 필터 (첨부 이미지 느낌)
  setTimeout(()=>{
    const mapPane = document.querySelector('.leaflet-map-pane');
    if(mapPane) mapPane.style.filter =
      "contrast(1.18) saturate(1.13) brightness(1.04) hue-rotate(-10deg)";
  }, 600);

  let chart, elevations=[], distances=[], latlngs=[];
  let highlightMarker, kmMarkers=[], polyline, startLabel, endLabel;
  let totalAsc=0, totalDesc=0;
  const cpList = [
    { km:10, label:'CP1' },
    { km:23, label:'CP2' },
    { km:34, label:'CP3' },
    { km:46, label:'CP4' }
  ];

  fetch(gpxUrl)
    .then(res=>res.text())
    .then(xmlText=>{
      const parser=new DOMParser();
      const xml=parser.parseFromString(xmlText,"application/xml");
      const trkpts=xml.querySelectorAll('trkpt');
      latlngs=[]; elevations=[]; distances=[0];
      trkpts.forEach((pt,i)=>{
        const lat=+pt.getAttribute('lat'), lon=+pt.getAttribute('lon');
        const ele=+pt.querySelector('ele').textContent;
        latlngs.push([lat,lon]); elevations.push(ele);
        if(i>0) distances[i]=distances[i-1]+getDistance(latlngs[i-1][0],latlngs[i-1][1],lat,lon);
      });
      totalAsc=0; totalDesc=0;
      for(let i=1;i<elevations.length;i++){
        const diff=elevations[i]-elevations[i-1];
        if(diff>0) totalAsc+=diff; else totalDesc-=diff;
      }
      polyline=L.polyline(latlngs,{
        color:'#e70013',weight:6.5,opacity:0.98,lineCap:'round'
      }).addTo(map);
      map.fitBounds(polyline.getBounds(),{padding:[17,17]});
      drawKmMarkers(); drawStartEnd();

      // 지도 마우스오버(고도/거리 info)
      polyline.on('mousemove',e=>{
        const idx=getClosestIndex(e.latlng,latlngs);
        highlightOnMap(idx);
        showHoverInfo('map',idx,e);
      });
      polyline.on('mouseout',()=>{removeHighlight();hideHoverInfo('map');});

      drawElevationChart();
      drawElevInfoTable();
      drawCpMarks();
    });

  function drawKmMarkers(){
    const totalKm=distances[distances.length-1]/1000;
    for(let k=5;k<=Math.floor(totalKm)+1;k+=5){
      const idx=distances.findIndex(d=>d/1000>=k);
      if(idx!==-1){
        const marker=L.circleMarker(latlngs[idx],{
          radius:14,color:'#e70013',fillColor:'#e70013',fillOpacity:1,weight:2
        }).addTo(map);
        const div=L.divIcon({
          className:"km-label",
          html:`<span>${k}</span>`,
          iconSize:[22,22],iconAnchor:[11,11]
        });
        const label=L.marker(latlngs[idx],{icon:div,interactive:false}).addTo(map);
        kmMarkers.push(marker,label);
      }
    }
  }
  function drawStartEnd(){
    const startIdx = 0, endIdx = latlngs.length-1;
    const startIcon = L.circleMarker(latlngs[startIdx],{
      radius:13.3,color:'#e70013',fillColor:'#fff',fillOpacity:1,weight:5
    }).addTo(map);
    const endIcon = L.circleMarker(latlngs[endIdx],{
      radius:13.3,color:'#e70013',fillColor:'#fff',fillOpacity:1,weight:5
    }).addTo(map);
    startLabel = L.marker(latlngs[startIdx],{
      icon: L.divIcon({
        className:'start-label',
        html:'START',
        iconAnchor: [52, 45]
      }), interactive:false
    }).addTo(map);
    endLabel = L.marker(latlngs[endIdx],{
      icon: L.divIcon({
        className:'end-label',
        html:'FINISH',
        iconAnchor: [52, 45]
      }), interactive:false
    }).addTo(map);
  }
  function drawElevationChart(){
    const kmArr=distances.map(m=>(m/1000).toFixed(2));
    const ctx=document.getElementById('elevation').getContext('2d');
    if(chart) chart && chart.destroy();
    // 상→하 블루 그라데이션, 자연스럽게 0까지 fade
    const grad=ctx.createLinearGradient(0,0,0,ctx.canvas.height);
    grad.addColorStop(0,"rgba(22,100,154,0.34)");
    grad.addColorStop(0.75,"rgba(22,100,154,0.09)");
    grad.addColorStop(1,"rgba(22,100,154,0.00)");
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels:kmArr,
        datasets:[{
          label:'고도(m)',data:elevations,
          borderColor:'#16649A',
          backgroundColor:grad,
          borderWidth:3,
          pointRadius:0,
          fill:true,
          tension:0.16
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{enabled:false}},
        elements:{line:{borderWidth:3}},
        scales:{
          x:{
            display:true,
            title:{display:true,text:'거리 (km)',color:'#e70013',font:{size:18,weight:'bold',family:'Pretendard'}},
            ticks:{
              color:'#e70013',
              font:{size:15,weight:'bold',family:'Pretendard'},
              callback:function(value,index){
                const v = parseFloat(kmArr[index]);
                if (v % 10 === 0) return v.toFixed(0);
                return '';
              }
            },
            grid:{color:'#e7e7e7'}
          },
          y:{
            display:true,
            title:{display:true,text:'고도 (m)',color:'#16649A',font:{size:18,weight:'bold',family:'Pretendard'}},
            ticks:{
              color:'#16649A',
              font:{size:15,weight:'bold',family:'Pretendard'},
              callback:function(value){if(value%200===0)return value;return '';}
            },
            grid:{color:'#f2e6e6'}
          }
        },
        interaction:{mode:'index',intersect:false},
        animation:{duration:120},
        onHover: (event, chartElements) => {
          if(chartElements.length) {
            const i = chartElements[0].index;
            showHoverInfo('elev',i,event);
            highlightOnMap(i);
          }
        },
        onLeave: () => {
          hideHoverInfo('elev');
          removeHighlight();
        }
      }
    });

    // Elevation 차트 마우스 이동 Info
    ctx.canvas.addEventListener('mousemove', (e) => {
      const points = chart.getElementsAtEventForMode(e, 'index', {intersect:false}, false);
      if(points.length) {
        const idx = points[0].index;
        showHoverInfo('elev',idx,e);
        highlightOnMap(idx);
      }
    });
    ctx.canvas.addEventListener('mouseleave', () => {
      hideHoverInfo('elev');
      removeHighlight();
    });
  }
  function drawElevInfoTable(){
    const totalDist=(distances[distances.length-1]/1000).toFixed(2);
    const asc=Math.round(totalAsc),desc=Math.round(totalDesc),cpCount=cpList.length;
    document.getElementById('elevInfoTable').innerHTML=
      `<span><span class="label">거리</span> <span class="value">${totalDist}km</span></span>
       <span><span class="label">총상승</span> <span class="value">${asc}m</span></span>
       <span><span class="label">총하강</span> <span class="value">${desc}m</span></span>
       <span><span class="label">CP</span> <span class="value">${cpCount}개</span></span>`;
  }
  function drawCpMarks(){
    const wrap=document.getElementById('cpMarks'); wrap.innerHTML='';
    const totalDist=distances[distances.length-1]/1000;
    cpList.forEach(({km,label},i)=>{
      const idx=distances.findIndex(d=>d/1000>=km);
      if(idx===-1) return;
      const left=((km/totalDist)*wrap.offsetWidth);
      const vline=document.createElement('div');
      vline.className='cp-vertline'; vline.style.left=`${left}px`; wrap.appendChild(vline);
      const dot=document.createElement('div');
      dot.className='cp-dot'; dot.style.left=`${left}px`; wrap.appendChild(dot);
      const txt=document.createElement('div');
      txt.className='cp-label'; txt.style.left=`${left}px`;
      txt.innerHTML=`${label}<br>${km}k`; wrap.appendChild(txt);
    });
  }
  function showHoverInfo(type, idx, evt) {
    const dist = (distances[idx]/1000).toFixed(2);
    const ele = elevations[idx].toFixed(0);
    let box, top, left;
    if(type==='map') {
      box = document.getElementById('hoverInfoMap');
      const wrap = document.getElementById('map');
      const rect = wrap.getBoundingClientRect();
      if(evt && evt.originalEvent) {
        left = evt.originalEvent.clientX - rect.left + 22;
        top = evt.originalEvent.clientY - rect.top - 32;
      } else { left = 30; top = 30; }
    } else {
      box = document.getElementById('hoverInfoElev');
      const wrap = document.getElementById('elevationBox');
      const rect = wrap.getBoundingClientRect();
      if(evt && evt.clientX) {
        left = evt.clientX - rect.left + 10;
        top = evt.clientY - rect.top - 38;
      } else { left = 35; top = 15; }
    }
    box.innerHTML =
      `<span style="color:#16649A;font-weight:700">${dist} km</span> /
       <span style="color:#16649A;">${ele} m</span>`;
    box.style.left = left + 'px'; box.style.top = top + 'px';
    box.style.display = 'block';
  }
  function hideHoverInfo(type) {
    if(type==='map') document.getElementById('hoverInfoMap').style.display='none';
    else document.getElementById('hoverInfoElev').style.display='none';
  }
  function highlightOnMap(idx){
    if(!latlngs[idx])return;
    if(highlightMarker)map.removeLayer(highlightMarker);
    highlightMarker=L.circleMarker(latlngs[idx],{
      radius:10,color:'#e70013',fillColor:'#fff',fillOpacity:1,weight:3
    }).addTo(map);
  }
  function removeHighlight(){if(highlightMarker)map.removeLayer(highlightMarker);}
  function getClosestIndex(latlng,arr){
    let minD=1e9,idx=0;
    arr.forEach((p,i)=>{const d=map.distance(latlng,p);if(d<minD){minD=d;idx=i;}});
    return idx;
  }
  function getDistance(lat1,lon1,lat2,lon2){
    const R=6371000,toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }
  window.addEventListener('resize',drawCpMarks);
  </script>
</body>
</html>
