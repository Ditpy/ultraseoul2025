<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1080">
  <title>ULTRA SEOUL 2025 - 50K GPX</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.8/dist/web/static/pretendard.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root {
      --color-point: #e70013;
      --color-elev-line: #16649A;
      --color-x-label: #16649A;
      --color-grid: #f1f1f1;
      --color-y-label: #333;
      --color-mountain-label: #fff;
      --color-mountain-shadow: #222;
      --btn-radius: 2.2em;
    }
    html, body { margin:0; padding:0; background:#191c1d; font-family:Pretendard, 'Segoe UI', Arial, sans-serif; }
    #container { max-width: 1080px; margin: 0 auto; }
    #map-wrap { position:relative; }
    #map {
      width: 60vw; max-width: 648px; height: 14vw; min-height: 110px; max-height: 158px;
      border-radius: 1.1em 1.1em 0 0;
      box-shadow: 0 2px 17px rgba(0,0,0,0.20);
      overflow: hidden;
      background: #181c22;
      z-index: 1;
      filter: saturate(0.75) brightness(1.13) contrast(1.16) hue-rotate(-28deg);
    }
    .mountain-label {
      position: absolute;
      color: var(--color-mountain-label);
      font-weight: 800;
      font-size: 1.23em;
      text-shadow:
        0 2px 8px var(--color-mountain-shadow),
        0 0 2px var(--color-mountain-shadow),
        0 0 1px var(--color-mountain-shadow);
      z-index: 20;
      pointer-events: none;
      font-family: Pretendard,sans-serif;
      letter-spacing: 0.03em;
      user-select: none;
      white-space: nowrap;
    }
    #elevationBox {
      width: 60vw; max-width: 648px; min-width: 220px;
      height: 6.33vw; min-height: 45px; max-height: 79px;
      background: #fff;
      border-radius: 0 0 1.1em 1.1em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      margin: 0 auto 2.8vw auto;
      position: relative;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-top: 4.9em;
    }
    #elevInfoTable {
      position: absolute;
      left: 50%; top: 0.9em; transform: translateX(-50%);
      z-index: 10; display: flex; flex-direction: column; gap: 0.2em; align-items: stretch;
      background: rgba(255,255,255,0.96); border-radius: 0.8em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1.5px solid #eee;
      padding: 0.58em 1em;
      font-size: 0.97em;
      font-weight: 500;
      color: #262626;
      min-width: 8em;
      justify-content: center;
      align-items: center;
      font-family: Pretendard, 'Segoe UI', Arial, sans-serif;
      letter-spacing: 0.01em;
    }
    .elev-row { display: flex; flex-direction: row; gap: 2.2em; justify-content: flex-start; }
    .elev-col { min-width: 7em; font-size: 1em; }
    .label { color: #666; font-weight: 400; margin-right: 0.3em; }
    .value { color: #e70013; font-weight: 700; }
    #elevation {
      width: 97vw; max-width: 606px; min-width: 120px;
      height: 6vw; min-height: 40px; max-height: 75px;
      margin: 0 auto; display: block; background: #fff;
      border-radius: 0.6em;
    }
    #cpMarks {
      width: 97vw; max-width: 606px; min-width: 120px;
      position: absolute; left: 1.8vw; top: 4.1em; height: 72px; z-index: 11; pointer-events: none;
      /* height는 elevation 캔버스와 맞춰야 함 */
    }
    .cp-vertline {
      position: absolute; width: 0.13em; background: rgba(231,0,19,0.22); left:0; border-radius: 2px;
      z-index: 2;
    }
    .cp-dot {
      position: absolute; width: 1em; height: 1em; left: -0.5em;
      background: var(--color-point); border-radius: 50%; border: 0.17em solid #fff; z-index: 3;
      box-shadow: 0 2px 7px rgba(231,0,19,0.11);
    }
    .cp-label {
      position: absolute; left: 50%;
      font-size: 0.96em; color: var(--color-point); font-weight: 700;
      text-align: center; font-family: Pretendard,'Segoe UI',Arial,sans-serif;
      background: none; border-radius: 0.3em; padding: 0 0.2em; user-select: none; pointer-events: none;
      letter-spacing: 0.01em; margin-bottom: 0.1em; z-index:4;
    }
    .hoverInfo {
      position: fixed;
      pointer-events: none; z-index: 1000;
      background: #fff; border: 2px solid var(--color-point);
      border-radius: 0.7em; color: #1a1a1a; font-size: 1.1em;
      font-family: Pretendard, sans-serif;
      padding: 0.42em 1.1em; box-shadow: 0 2px 10px rgba(231,0,19,0.14);
      font-weight: 600; white-space: nowrap; transition:top .07s,left .07s;
      display: none;
    }
    .km-label {
      color: #fff; font-weight: bold; font-size: 1.09em; text-align: center;
      text-shadow: none; pointer-events: none; font-family: Pretendard, sans-serif;
      background: none; border-radius: 0;
    }
    .start-label, .end-label {
      background: var(--color-point); color: #fff; font-weight: 700; font-size: 0.98em;
      padding: 0.12em 0.8em; border-radius: 1.1em; border: 2px solid #fff;
      font-family: Pretendard, sans-serif; box-shadow: none; pointer-events: none; user-select: none;
      display: inline-block; letter-spacing: 0.02em; text-align: center;
      line-height: 1.15em; min-width: 3.4em;
    }
    #downloadBox {
      width: 29vw; max-width: 410px; min-width: 160px;
      min-height: 2.5em;
      background: var(--color-point);
      border-radius: 2.2em;
      color: #fff;
      font-family: Pretendard, sans-serif;
      padding: 0.6em 1.5em;
      box-shadow: 0 6px 24px rgba(231,0,19,0.16);
      font-size: 1.11em;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 10;
      font-weight: 500;
      letter-spacing: 0.01em;
      position: static;
      margin: 2.5em auto 2em auto;
    }
    #downloadBox .ultraseoul-btn {
      margin-top: 0.3em;
    }
    .ultraseoul-btn {
      background: var(--color-point);
      color: #fff;
      font-family: Pretendard, 'Segoe UI', Arial, sans-serif;
      font-size: 1.1em;
      font-weight: 700;
      border: none;
      border-radius: var(--btn-radius);
      box-shadow: 0 6px 19px rgba(231,0,19,0.14);
      padding: 0.5em 1.4em;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: background .18s, box-shadow .18s, color .15s;
      display: inline-block;
      user-select: none;
      min-width: 7em;
      text-align: center;
      text-decoration: none;
    }
    .ultraseoul-btn:hover,
    .ultraseoul-btn:focus {
      background: #c90012;
      box-shadow: 0 4px 13px rgba(231,0,19,0.17);
      color: #fff;
      text-decoration: none;
    }
    .ultraseoul-btn:active {
      background: #b6000f;
      color: #fff;
      box-shadow: 0 1.5px 5px rgba(231,0,19,0.10);
    }
    @media (max-width: 900px) {
      #container, #map, #elevationBox { max-width: 99vw; }
      #elevInfoTable { font-size: 1em; min-width: 11em; }
      #downloadBox { min-width: 13em; font-size: 1em; }
      .ultraseoul-btn { font-size: 1em; padding: 0.65em 1.3em; min-width: 7em; }
      #map, #elevationBox { max-width: 99vw; }
      #elevation, #cpMarks { max-width: 95vw; }
    }
    @media (max-width: 650px) {
      #container, #map, #elevationBox { max-width: 100vw; min-width: 100vw; }
      #elevInfoTable { padding: 0.4em 0.5em; font-size:0.95em;}
      #downloadBox { padding: 0.7em 1.2em; font-size: 0.92em;}
      .cp-label { font-size: 0.87em; }
      #elevation { min-width: 120px; }
      #elevation, #cpMarks { max-width: 97vw; }
    }
    #gpxErrorMsg { color: #e70013; font-size: 1.1em; margin: 2em auto; text-align: center; font-family: Pretendard;}
  </style>
</head>
<body>
  <div id="container">
    <div id="map-wrap" style="position:relative;">
      <div id="map"></div>
      <div id="hoverInfoMap" class="hoverInfo"></div>
      <!-- 산 이름 라벨 컨테이너 -->
      <div id="mountainLabels"></div>
    </div>
    <div id="elevationBox">
      <div id="elevInfoTable"></div>
      <div id="cpMarks"></div>
      <canvas id="elevation"></canvas>
      <div id="hoverInfoElev" class="hoverInfo"></div>
      <div id="gpxErrorMsg" style="display:none;"></div>
    </div>
    <div id="downloadBox">
      <a href="https://raw.githubusercontent.com/Ditpy/ultraseoul2025/main/ultraseoul2025_50k_gm.gpx" download="ultraseoul2025_50k_gm.gpx" class="ultraseoul-btn">GPX DOWNLOAD</a>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.js"></script>
  <script>
  // GPX는 반드시 RAW.githubusercontent.com 절대경로 사용인데 여기서는 다름 ultraseoul2025_50k_gm.gpx!
  const gpxUrl = './ultraseoul2025_50k_gm.gpx';
 
  // 산 이름, 위도, 경도 예시 (적절히 수정하세요!)
  const mountains = [
    { name: "함백산", lat: 37.1463, lon: 128.9774 },
    { name: "태백산 천제단", lat: 37.0882, lon: 128.9360 },
    { name: "소문수봉", lat: 37.0930, lon: 128.9470 }
  ];

  const map = L.map('map', {
    dragging:true, scrollWheelZoom:false, doubleClickZoom:false,
    boxZoom:false, touchZoom:false, keyboard:false,
    zoomControl:false, attributionControl:false,
  }).setView([37.125,128.97],12);

  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom:17, attribution:'Tiles © Esri'
  }).addTo(map);

  setTimeout(()=>{
    const mapPane = document.querySelector('.leaflet-map-pane');
    if(mapPane) mapPane.style.filter =
      "saturate(0.63) brightness(1.22) contrast(1.25) hue-rotate(-52deg)";
  }, 600);

  let chart, elevations=[], distances=[], latlngs=[];
  let highlightMarker, kmMarkers=[], polyline, startLabel, endLabel;
  let totalAsc=0, totalDesc=0;
  const cpList = [
    { km:10, label:'CP1' },
    { km:19, label:'CP2' },
    { km:30, label:'CP3' },
    { km:36, label:'CP4' },
    { km:44, label:'CP5' }
  ];

  fetch(gpxUrl)
    .then(res=>{
      if (!res.ok) throw new Error("GPX 파일을 불러올 수 없습니다.");
      return res.text();
    })
    .then(xmlText=>{
      document.getElementById('gpxErrorMsg').style.display = 'none';
      const parser=new DOMParser();
      const xml=parser.parseFromString(xmlText,"application/xml");
      const trkpts=xml.querySelectorAll('trkpt');
      latlngs=[]; elevations=[]; distances=[0];
      trkpts.forEach((pt,i)=>{
        const lat=+pt.getAttribute('lat'), lon=+pt.getAttribute('lon');
        const ele=+pt.querySelector('ele').textContent;
        latlngs.push([lat,lon]); elevations.push(ele);
        if(i>0) distances[i]=distances[i-1]+getDistance(latlngs[i-1][0],latlngs[i-1][1],lat,lon);
      });
      totalAsc=0; totalDesc=0;
      for(let i=1;i<elevations.length;i++){
        const diff=elevations[i]-elevations[i-1];
        if(diff>0) totalAsc+=diff; else totalDesc-=diff;
      }
      polyline=L.polyline(latlngs,{
        color:'#16649A',weight:4,opacity:0.99,lineCap:'round'
      }).addTo(map);
      map.fitBounds(polyline.getBounds(),{padding:[17,17]});
      drawKmMarkers(); drawStartEnd();
      drawMountainLabels();

      polyline.on('mousemove',e=>{
        const idx=getClosestIndex(e.latlng,latlngs);
        highlightOnMap(idx);
        showHoverInfo('elev',idx,e,true); // 지도에서도 고도정보 팝업
      });
      polyline.on('mouseout',()=>{removeHighlight();hideHoverInfo('elev');});

      drawElevationChart();
      drawElevInfoTable();
      drawCpMarks();
      window.addEventListener('resize',drawCpMarks);
    })
    .catch(err=>{
      document.getElementById('gpxErrorMsg').style.display = 'block';
      document.getElementById('gpxErrorMsg').innerText =
        "코스 GPX 파일을 불러올 수 없습니다. (ultraseoul2025_50k_gm.gpx 파일이 서버에 없거나 경로가 잘못되었습니다)";
    });

  function drawMountainLabels() {
    // 지도 컨테이너에 라벨 DOM 추가
    const wrap = document.getElementById('mountainLabels');
    wrap.innerHTML = '';
    mountains.forEach(m => {
      const p = map.latLngToContainerPoint([m.lat, m.lon]);
      const div = document.createElement('div');
      div.className = 'mountain-label';
      div.style.left = (p.x-28) + 'px';
      div.style.top = (p.y-18) + 'px';
      div.textContent = m.name;
      wrap.appendChild(div);
    });
    map.on('move zoom', function(){
      mountains.forEach((m,i) => {
        const p = map.latLngToContainerPoint([m.lat, m.lon]);
        const div = wrap.children[i];
        div.style.left = (p.x-28) + 'px';
        div.style.top = (p.y-18) + 'px';
      });
    });
  }

  function drawKmMarkers(){
    if (!latlngs.length) return;
    const totalKm=distances[distances.length-1]/1000;
    for(let k=5;k<=Math.floor(totalKm)+1;k+=5){
      const idx=distances.findIndex(d=>d/1000>=k);
      if(idx!==-1){
        const marker=L.circleMarker(latlngs[idx],{
          radius:12,color:'#16649A',fillColor:'#16649A',fillOpacity:1,weight:2
        }).addTo(map);
        const div=L.divIcon({
          className:"km-label",
          html:`<span>${k}</span>`,
          iconSize:[22,22],iconAnchor:[11,11]
        });
        const label=L.marker(latlngs[idx],{icon:div,interactive:false}).addTo(map);
        kmMarkers.push(marker,label);
      }
    }
  }
  function drawStartEnd(){
    if (!latlngs.length) return;
    const startIdx = 0, endIdx = latlngs.length-1;
    L.circleMarker(latlngs[startIdx],{
      radius:11,color:'#16649A',fillColor:'#fff',fillOpacity:1,weight:4
    }).addTo(map);
    L.circleMarker(latlngs[endIdx],{
      radius:11,color:'#16649A',fillColor:'#fff',fillOpacity:1,weight:4
    }).addTo(map);
    L.marker(latlngs[startIdx],{
      icon: L.divIcon({
        className:'start-label',
        html:'START',
        iconAnchor: [42, 40]
      }), interactive:false
    }).addTo(map);
    L.marker(latlngs[endIdx],{
      icon: L.divIcon({
        className:'end-label',
        html:'FINISH',
        iconAnchor: [42, 40]
      }), interactive:false
    }).addTo(map);
  }

  function drawElevationChart(){
    if (!elevations.length || !distances.length) return;
    const kmArr=distances.map(m=>(m/1000).toFixed(2));
    const ctx=document.getElementById('elevation').getContext('2d');
    if(chart) chart.destroy();
    const grad=ctx.createLinearGradient(0,0,0,ctx.canvas.height);
    grad.addColorStop(0,"rgba(22,100,154,0.23)");
    grad.addColorStop(0.82,"rgba(22,100,154,0.03)");
    grad.addColorStop(1,"rgba(22,100,154,0.00)");
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels:kmArr,
        datasets:[{
          label:'고도(m)',data:elevations,
          borderColor:'#16649A',
          backgroundColor:grad,
          borderWidth:2,
          pointRadius:0,
          fill:true,
          tension:0.16
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{enabled:false},
        },
        elements:{line:{borderWidth:2}},
        scales:{
          x:{
            display:true,
            title:{display:true,text:'Distance(km)',color:'#16649A',font:{size:15,weight:'bold',family:'Pretendard'}},
            ticks:{
              color:'#16649A',
              font:{size:12,weight:'bold',family:'Pretendard'},
              callback:function(value,index){
                const v = parseFloat(kmArr[index]);
                if (v % 10 === 0) return v.toFixed(0);
                return '';
              }
            },
            grid:{
              color:()=> 'rgba(0,0,0,0)', // 세로선 제거
              drawOnChartArea:false,
              drawTicks:true
            }
          },
          y:{
            display:true,
            title:{display:true,text:'Height(m)',color:'#333',font:{size:15,weight:'bold',family:'Pretendard'}},
            ticks:{
              color:'#333',
              font:{size:12,weight:'bold',family:'Pretendard'},
              callback:function(value){
                if(value%200===0)return value;return '';
              }
            },
            grid:{
              color: (ctx)=>ctx.tick.value%200===0? 'var(--color-grid)' : 'rgba(0,0,0,0)',
              drawTicks:true,
              drawBorder:false,
              tickColor:'#333',
              lineWidth:1.1
            }
          }
        },
        interaction:{mode:'index',intersect:false},
        animation:{duration:120},
        onHover: (ev, chartElements) => {
          if(chartElements.length) {
            const i = chartElements[0].index;
            showHoverInfo('elev',i,ev,true);
            highlightOnMap(i);
          }
        },
        onLeave: () => {
          hideHoverInfo('elev');
          removeHighlight();
        }
      }
    });

    ctx.canvas.addEventListener('mousemove', (e) => {
      const points = chart.getElementsAtEventForMode(e, 'index', {intersect:false}, false);
      if(points.length) {
        const idx = points[0].index;
        showHoverInfo('elev',idx,e,true);
        highlightOnMap(idx);
      }
    });
    ctx.canvas.addEventListener('mouseleave', () => {
      hideHoverInfo('elev');
      removeHighlight();
    });
  }

  function drawElevInfoTable(){
    const maxEle = Math.max(...elevations);
    const totalUp = Math.round(totalAsc);
    const totalDown = Math.round(totalDesc);
    const totalDist = (distances[distances.length-1]/1000).toFixed(2);
    const allGain = totalUp + totalDown;
    document.getElementById('elevInfoTable').innerHTML = `
      <div class="elev-row">
        <div class="elev-col"><span class="label">거리</span> <span class="value">${totalDist}km</span></div>
        <div class="elev-col"><span class="label">누적 상승 고도</span> <span class="value">${totalUp}m</span></div>
        <div class="elev-col"><span class="label">누적 하강 고도</span> <span class="value">${totalDown}m</span></div>
      </div>
      <div class="elev-row">
        <div class="elev-col"><span class="label">최고 고도</span> <span class="value">${maxEle}m</span></div>
        <div class="elev-col"><span class="label">전체 누적 고도</span> <span class="value">${allGain}m</span></div>
        <div class="elev-col"></div>
      </div>
    `;
  }

  function drawCpMarks() {
    const wrap = document.getElementById('cpMarks');
    wrap.innerHTML = '';
    const totalDist = distances[distances.length-1]/1000;
    const minEle = Math.min(...elevations), maxEle = Math.max(...elevations);
    const h = wrap.offsetHeight;
    cpList.forEach(({km,label})=>{
      const idx = distances.findIndex(d=>d/1000>=km);
      if(idx===-1) return;
      const left = (km/totalDist)*wrap.offsetWidth;
      const ele = elevations[idx];
      const top = h - ((ele - minEle)/(maxEle-minEle)) * h;
      // 세로선(고도선 접점까지만)
      const vline = document.createElement('div');
      vline.className = 'cp-vertline';
      vline.style.left = `${left}px`;
      vline.style.top = '0';
      vline.style.height = `${top}px`;
      wrap.appendChild(vline);
      // 동그라미(고도선 접점)
      const dot = document.createElement('div');
      dot.className = 'cp-dot';
      dot.style.left = `${left}px`;
      dot.style.top = `${top-7}px`;
      wrap.appendChild(dot);
      // 텍스트
      const txt = document.createElement('div');
      txt.className = 'cp-label';
      txt.style.left = `${left}px`;
      txt.style.top = `${top-23}px`;
      txt.innerHTML = `${label}<br>${km}k`;
      wrap.appendChild(txt);
    });

    // 하단 10km 단위 라벨
    const labelWrap = document.createElement('div');
    labelWrap.style.position = 'absolute';
    labelWrap.style.left = '0'; labelWrap.style.bottom = '-16px';
    labelWrap.style.width = '100%';
    labelWrap.style.pointerEvents = 'none';
    labelWrap.style.display = 'flex';
    labelWrap.style.justifyContent = 'space-between';
    let totalKm = Math.round(totalDist/10)*10;
    for(let k=0;k<=totalKm;k+=10){
      const lab = document.createElement('span');
      lab.textContent = k;
      lab.style.color = '#16649A';
      lab.style.fontWeight = 'bold';
      lab.style.fontSize = '0.97em';
      lab.style.position = 'absolute';
      lab.style.left = (k/totalDist*100) + '%';
      lab.style.transform = 'translateX(-50%)';
      labelWrap.appendChild(lab);
    }
    wrap.appendChild(labelWrap);
  }

  // 고도/거리 info : 마우스 따라가도록
  function showHoverInfo(type, idx, evt, followMouse) {
    const dist = (distances[idx]/1000).toFixed(2);
    const ele = elevations[idx].toFixed(0);
    let box = document.getElementById('hoverInfoElev');
    let left = 30, top = 30;
    if(evt && followMouse) {
      if(evt.touches && evt.touches.length) {
        left = evt.touches[0].clientX + 10;
        top = evt.touches[0].clientY - 30;
      } else {
        left = evt.clientX + 10;
        top = evt.clientY - 30;
      }
    }
    box.innerHTML =
      `<span style="color:#16649A;font-size:1.12em;font-weight:900;">${dist} km</span>
       <span style="color:#16649A;font-size:1.12em;font-weight:900;">/ ${ele} m</span>`;
    box.style.left = left + 'px'; box.style.top = top + 'px';
    box.style.display = 'block';
  }
  function hideHoverInfo() {
    document.getElementById('hoverInfoElev').style.display='none';
  }
  function highlightOnMap(idx){
    if(!latlngs[idx])return;
    if(highlightMarker)map.removeLayer(highlightMarker);
    highlightMarker=L.circleMarker(latlngs[idx],{
      radius:8,color:'#16649A',fillColor:'#fff',fillOpacity:1,weight:2
    }).addTo(map);
  }
  function removeHighlight(){if(highlightMarker)map.removeLayer(highlightMarker);}
  function getClosestIndex(latlng,arr){
    let minD=1e9,idx=0;
    arr.forEach((p,i)=>{const d=map.distance(latlng,p);if(d<minD){minD=d;idx=i;}});
    return idx;
  }
  function getDistance(lat1,lon1,lat2,lon2){
    const R=6371000,toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }
  </script>
</body>
</html>
